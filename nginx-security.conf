# Nginx Security Headers Configuration for PILLAR Media
# Include this file in your nginx server block

# Security Headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(self)" always;

# Content Security Policy
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://www.google-analytics.com https://fonts.googleapis.com https://player.vimeo.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: blob:; connect-src 'self' https://js.stripe.com https://www.google-analytics.com; frame-src https://js.stripe.com https://player.vimeo.com; media-src 'self' https:; object-src 'none'; base-uri 'self'; form-action 'self' https://checkout.stripe.com; frame-ancestors 'self';" always;

# HSTS - HTTP Strict Transport Security (1 year)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Remove Server header
server_tokens off;
more_clear_headers 'Server';

# Force HTTPS
if ($scheme != "https") {
    return 301 https://$server_name$request_uri;
}

# Remove www (or add www - choose one)
if ($host ~ ^www\.(.+)$) {
    set $host_without_www $1;
    return 301 https://$host_without_www$request_uri;
}

# Gzip Compression
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/rss+xml
    application/atom+xml
    image/svg+xml
    text/x-component
    font/truetype
    font/opentype
    application/vnd.ms-fontobject;

# Browser Caching
location ~* \.(jpg|jpeg|png|gif|ico|webp|svg|css|js|woff|woff2|ttf|otf)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

location ~* \.(html|htm|xml|txt)$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}

# Service Worker - never cache
location = /sw.js {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}

# Protect sensitive files
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ /(package\.json|composer\.json|\.env|\.git|\.gitignore) {
    deny all;
    access_log off;
    log_not_found off;
}

# Block bad bots
if ($http_user_agent ~* (AhrefsBot|SemrushBot|MJ12bot|DotBot|BLEXBot)) {
    return 403;
}

# Remove .html extension
location / {
    try_files $uri $uri.html $uri/ =404;
}
